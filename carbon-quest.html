<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbon Quest - Professional Pitch Demo</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a professional aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        /* NATURE VIBES: Changed background to a very pale, natural off-white/green */
        body { font-family: 'Inter', sans-serif; background-color: #fafff5; } 
        
        .header-shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card { 
            background: white; 
            border-radius: 0.75rem; /* Slightly less rounded */
            /* NATURE VIBES: Softened shadow for a less 'hard' look */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04), 0 2px 5px rgba(0, 0, 0, 0.02); 
            /* NATURE VIBES: Subtle light green/gray border */
            border: 1px solid #e0e7e9; 
        }
        .input-style {
            border: 1px solid #cbd5e1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-style:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 1px #10b981;
            outline: none;
        }
        /* --- COOLER BUTTON STYLES --- */
        .btn-primary { 
            /* Gradient for depth, stronger shadow */
            background-image: linear-gradient(to right, #10b981 0%, #059669 100%);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother transition */
            border: none;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); /* Stronger shadow */
            color: white; /* Ensure text is white */
            font-weight: 700; /* Bold text */
        }
        .btn-primary:hover { 
            /* Shift gradient, lift element, reduce shadow opacity slightly */
            background-image: linear-gradient(to left, #10b981 0%, #059669 100%);
            transform: translateY(-2px); /* Higher lift on hover */
            box-shadow: 0 8px 20px rgba(5, 150, 105, 0.5); 
        }
        .btn-primary:active {
            /* Press effect */
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(5, 150, 105, 0.3);
        }
        /* --- END COOLER BUTTON STYLES --- */
        
        .floating-bot {
            position: fixed; bottom: 1.5rem; right: 1.5rem;
            cursor: pointer; z-index: 50;
            /* Removed distracting pulsing animation */
        }
        /* DASHBOARD ENHANCEMENTS */
        .stat-box {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            /* Default subtle shadow */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        .stat-box:hover {
            transform: translateY(-2px);
        }
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0.1;
            pointer-events: none;
            z-index: 10;
        }
        /* Specific stat box colors and gradients */
        .stat-box-green {
            border: 1px solid #059669;
        }
        .stat-box-green::before {
            background: linear-gradient(135deg, #a7f3d0 0%, transparent 50%);
        }
        .stat-box-blue {
            border: 1px solid #3b82f6;
        }
        .stat-box-blue::before {
            background: linear-gradient(135deg, #bfdbfe 0%, transparent 50%);
        }
        .stat-box-red {
            border: 1px solid #ef4444;
        }
        .stat-box-red::before {
            background: linear-gradient(135deg, #fecaca 0%, transparent 50%);
        }
        .stat-box-orange {
            border: 1px solid #f97316;
        }
        .stat-box-orange::before {
            background: linear-gradient(135deg, #fed7aa 0%, transparent 50%);
        }

        /* Styles for the new Stacked Bar Footprint Chart */
        .stacked-bar-container {
            height: 2.5rem; /* Taller bar for impact */
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .stacked-bar-segment {
            height: 100%;
            transition: width 0.8s cubic-bezier(0.23, 1, 0.32, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            font-size: 0.875rem;
            font-weight: 600;
        }
        /* Styles for Achievements Page */
        .achieve-day {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-size: 15px;
            font-weight: 700;
        }
    </style>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase references
        window.firebase = {};
        const DIET_FACTORS = {
            'omnivore': 1.0,
            'vegetarian': 0.6,
            'vegan': 0.4
        };

        const ELECTRICITY_KG_PER_KWH = 0.4; // Mock emission factor
        
        // Mock Leaderboard Data
        const MOCK_LEADERBOARD_USERS = [
            { id: 'mock-green-pioneer', name: 'GreenPioneer', totalPoints: 45000, co2ReducedKg: 850 },
            { id: 'mock-climate-champion', name: 'ClimateChamp', totalPoints: 32000, co2ReducedKg: 520 },
            { id: 'mock-eco-warrior', name: 'EcoWarrior', totalPoints: 21500, co2ReducedKg: 310 },
            { id: 'mock-recycled-robot', name: 'RecycledRobot', totalPoints: 18000, co2ReducedKg: 250 },
            { id: 'mock-tree-hugger', name: 'TreeHugger', totalPoints: 15000, co2ReducedKg: 180 },
        ];

        // Mock Group Data for the Demo, with icons added
        const MOCK_GROUPS = [
            { id: 'tree_huggers', name: 'The Tree Huggers', score: 95000, members: 12, motto: "Planting the seeds for a better tomorrow.", icon: 'leaf' },
            { id: 'eco_warriors', name: 'Eco-Warriors United', score: 120000, members: 25, motto: "Leading the charge in verifiable reduction.", icon: 'shield' },
            { id: 'green_machines', name: 'Green Machines', score: 88000, members: 8, motto: "Efficiency and clean energy is our game.", icon: 'bolt' },
        ];
        
        // --- MOCK ACHIEVEMENT DATA ---
        const MOCK_ACHIEVEMENT_DATA = {
            streaks: {
                current: 9, 
                longest: 14, 
                // Array representing the last 7 days of activity (0 = Missed, 1 = Complete)
                last7Days: [1, 1, 0, 1, 1, 1, 1] // Today is the rightmost element (Index 6)
            },
            badges: [
                { id: 1, name: "Initial Engagement", emoji: "üå±", earned: true, date: "01/05/2024", goal: "Complete 1st Initiative" },
                { id: 2, name: "Transport Optimization", emoji: "üö∂", earned: true, date: "03/10/2024", goal: "Log 5 days of low-carbon commute" },
                { id: 3, name: "Resource Management", emoji: "üóëÔ∏è", earned: true, date: "06/20/2024", goal: "Log 10 waste reduction actions" },
                { id: 4, name: "Systemic Efficiency", emoji: "üí°", earned: false, goal: "Reduce home energy use by 10%" },
                { id: 5, name: "Sustained Compliance", emoji: "üìà", earned: true, date: "08/01/2024", goal: "Achieve 7-day compliance streak" },
                { id: 6, name: "Load Shedding Champion", emoji: "üîå", earned: false, goal: "7 days of low peak energy use" },
                { id: 7, name: "Global Impact", emoji: "üåé", earned: false, goal: "Complete 10 strategic initiatives" },
                { id: 8, name: "Master Planner", emoji: "üß≠", earned: false, goal: "Set and meet 3 long-term goals" },
            ]
        };
        // -----------------------------

        // Global State Management
        window.state = {
            view: 'home', // 'home', 'calculator', 'dashboard', 'fullLeaderboard', 'achievements'
            userId: null,
            isAuthReady: false,
            userProfile: {
                name: 'Pitch Demo User',
                commuteMiles: 50,
                kwhMonthly: 500,
                diet: 'omnivore',
                flightsPerYear: 2,
                totalCo2Kg: 0,
                totalPoints: 500,
                co2ReducedKg: 0,
                lastQuestUpdate: new Date(0), // Force update on first load
                groupId: null, // Track current group membership
            },
            leaderboard: [],
            groups: MOCK_GROUPS, // Mock groups for the demo
            dailyQuests: [
                { id: 1, text: "Use public transport or cycle for one trip.", points: 300, complete: false },
                { id: 2, text: "Prepare one meatless meal today.", points: 200, complete: false },
                { id: 3, text: "Unplug 3 appliances not in use.", points: 100, complete: false },
            ],
            botResponse: "Hello! I'm CarbonBot, your AI guide. Ask me how to reduce your biggest source of emissions!",
            pitchView: null
        };

        // --- Firebase Initialization and Auth ---
        window.authInit = async () => {
            try {
                // Mandatory global variables check
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Using mock data only.");
                    window.state.isAuthReady = true;
                    // Seed local leaderboard with mock users if Firestore is not available
                    window.state.leaderboard = MOCK_LEADERBOARD_USERS.map((item, index) => ({
                         ...item, rank: index + 1
                    }));
                    window.render();
                    return; // Stop if config is missing, proceed with mock data
                }

                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                Object.assign(window.firebase, { app, auth, db, appId });

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }

                // Auth state change listener to set userId and start Firestore listeners
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.state.userId = user.uid;
                        window.state.isAuthReady = true;
                        console.log(`User signed in: ${user.uid}`);
                        window.seedLeaderboard(); // Seed mock users
                        window.fetchUserData();
                        window.startLeaderboardListener();
                    } else {
                        window.state.isAuthReady = true; // Still ready, just anonymous
                    }
                });

            } catch (error) {
                console.error("Firebase Auth or Init Error:", error);
                window.state.isAuthReady = true; // Allow app to run with mock data
            }
        };
        
        window.seedLeaderboard = async () => {
            const { db, appId } = window.firebase;
            if (!db) return;

            const collectionRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
            
            for (const mockUser of MOCK_LEADERBOARD_USERS) {
                const docRef = doc(collectionRef, mockUser.id);
                try {
                    // Use setDoc with merge to create or update the mock user
                    await setDoc(docRef, mockUser, { merge: true });
                } catch (error) {
                    console.error(`Error seeding mock user ${mockUser.id}:`, error);
                }
            }
            console.log("Mock leaderboard users seeded.");
        };

        // --- Firestore Data Handlers ---

        window.fetchUserData = () => {
            const { db, appId } = window.firebase;
            const { userId } = window.state;
            if (!userId || !db) return;

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);

            onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    window.state.userProfile = {
                        ...window.state.userProfile,
                        ...data,
                        // Ensure name is set if missing, but prioritize name from state
                        name: data.name || window.state.userProfile.name
                    };
                    console.log("User data updated from Firestore.");
                    window.updateQuests(data.lastQuestUpdate);
                    window.render();
                } else {
                    console.log("No user profile found. Creating initial profile.");
                    window.saveUserProfile(); // Create initial data
                }
            }, (error) => {
                console.error("Error fetching user data:", error);
            });
        };

        window.saveUserProfile = async (updateData = {}) => {
            const { db, appId } = window.firebase;
            const { userId, userProfile } = window.state;
            if (!userId || !db) return;

            const profileToSave = {
                ...userProfile,
                ...updateData
            };
            
            // Recalculate carbon footprint before saving
            profileToSave.totalCo2Kg = window.calculateCarbonFootprint(profileToSave);

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);

            try {
                await setDoc(userDocRef, profileToSave, { merge: true });
                window.state.userProfile = profileToSave; // Update local state immediately
                window.render();
                console.log("User profile saved successfully.");
            } catch (error) {
                console.error("Error saving user profile:", error);
            }
        };

        window.startLeaderboardListener = () => {
            const { db, appId } = window.firebase;
            if (!db) return;

            const leaderboardCollectionRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
            const q = query(leaderboardCollectionRef);

            onSnapshot(q, async (snapshot) => {
                let board = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                // Ensure the current user is on the leaderboard
                const userInBoard = board.find(item => item.id === window.state.userId);

                // If user data is ready and user is not in the board, add/update them
                if (window.state.isAuthReady && window.state.userId && window.state.userProfile.name) {
                    const { userId, userProfile } = window.state;

                    // Update user's leaderboard entry with their latest stats
                    const userRef = doc(db, `artifacts/${appId}/public/data/leaderboard/${userId}`);
                    const publicData = {
                        userId: userId,
                        name: userProfile.name,
                        totalPoints: userProfile.totalPoints,
                        co2ReducedKg: userProfile.co2ReducedKg
                    };
                    
                    await setDoc(userRef, publicData, { merge: true });

                    // Re-fetch after updating user's public record
                    const updatedSnapshot = await getDocs(q);
                    board = updatedSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                }

                // Sort by points descending and set rank
                board.sort((a, b) => b.totalPoints - a.totalPoints);
                window.state.leaderboard = board.map((item, index) => ({
                    ...item,
                    rank: index + 1
                }));

                window.render();
                console.log("Leaderboard updated from Firestore.");
            }, (error) => {
                console.error("Error fetching leaderboard:", error);
            });
        };

        window.updateQuests = (lastUpdate) => {
            const today = new Date();
            const lastQuestDate = lastUpdate instanceof Date ? lastUpdate : (lastUpdate?.toDate ? lastUpdate.toDate() : new Date(0));

            // Check if it's a new day since the last quest update
            const isNewDay = today.toDateString() !== lastQuestDate.toDateString();

            if (isNewDay) {
                console.log("New day detected. Resetting quests.");
                // Reset completion status for the new day
                window.state.dailyQuests = window.state.dailyQuests.map(q => ({ ...q, complete: false }));
                window.saveUserProfile({ lastQuestUpdate: today });
            } else {
                console.log("Quests remain the same for today.");
            }
        };

        // --- Core Application Logic ---

        window.calculateCarbonFootprint = (profile) => {
            const p = profile || window.state.userProfile;
            if (p.totalCo2Kg > 0 && profile === undefined) return p.totalCo2Kg; // Use cached value if available and not explicitly recalculating

            // Mock Calculation based on simplified factors (in kg CO2 / year)
            const travelCo2 = p.commuteMiles * 52 * 0.4; // 0.4 kg/mile for average car
            const homeCo2 = p.kwhMonthly * 12 * ELECTRICITY_KG_PER_KWH;
            const flightCo2 = p.flightsPerYear * 1000; // Mock 1000 kg per average long-haul flight
            const dietCo2 = 2500 * DIET_FACTORS[p.diet]; // Base diet footprint scaled

            const total = Math.round(travelCo2 + homeCo2 + flightCo2 + dietCo2);
            return Math.max(2000, total); // Ensure a reasonable minimum footprint
        };
        
        // Function to simulate the LLM call for CarbonBot
        window.getBotResponse = async (userQuery) => {
            const prompt = `Act as CarbonBot, a fun, gamified AI coach. The user's current annual $\text{CO}_2$ footprint is ${window.state.userProfile.totalCo2Kg} kg. Their biggest input factors are Transportation (commute: ${window.state.userProfile.commuteMiles} miles/week), Home Energy (usage: ${window.state.userProfile.kwhMonthly} kWh/month), and Diet (${window.state.userProfile.diet}). Respond concisely to the user's question, focusing on action and point rewards. User Query: "${userQuery}"`;
            
            window.state.botResponse = "ü§ñ Thinking... Analyzing your data for the most impactful advice!";
            window.render();

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "You are a fun, encouraging, gamified AI coach named CarbonBot. Keep responses short and action-oriented." }] },
            };

            // Implement exponential backoff for API call
            const maxRetries = 5;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I'm having trouble connecting to my carbon intelligence core right now!";
                    window.state.botResponse = text;
                    break; // Success, exit loop

                } catch (error) {
                    console.error("CarbonBot API call failed:", error);
                    window.state.botResponse = "Error: CarbonBot is currently offline. Please try again later.";
                }
            }
            window.render();
        };

        window.handleGroupAction = (groupId, action) => {
            const p = window.state.userProfile;
            let newGroupId = p.groupId;
            let message = '';
            const group = window.state.groups.find(g => g.id === groupId);

            if (!group) {
                message = "Error: Group not found.";
            } else if (action === 'join') {
                if (p.groupId === groupId) {
                    message = `You are already a member of ${group.name}.`;
                } else {
                    const oldGroup = p.groupId ? window.state.groups.find(g => g.id === p.groupId) : null;
                    newGroupId = groupId;
                    message = `Joined ${group.name}! ${oldGroup ? `(Left ${oldGroup.name})` : ''} Go check out the group score!`;
                }
            } else if (action === 'leave' && p.groupId === groupId) {
                newGroupId = null;
                message = `Successfully left ${group.name}.`;
            } else {
                 message = "Operation failed. You are not currently in this group.";
            }

            // Update local state and save to Firestore
            window.saveUserProfile({ groupId: newGroupId });

            // Show confirmation
            const conf = document.getElementById('message-box');
            const color = (action === 'join' && newGroupId === groupId) ? 'text-[#059669]' : action === 'leave' ? 'text-red-500' : 'text-gray-700';
            conf.querySelector('#message-content').innerHTML = `
                <p class="text-2xl font-bold ${color} mb-3">${action === 'join' && newGroupId === groupId ? 'GROUP JOINED!' : action === 'leave' && !newGroupId ? 'GROUP LEFT' : 'STATUS'}</p>
                <p class="text-gray-700">${message}</p>
            `;
            conf.classList.remove('hidden');
            document.getElementById('message-action').innerHTML = `
                <button onclick="document.getElementById('message-box').classList.add('hidden');" class="px-6 py-2 btn-primary text-white rounded-lg">OK</button>
            `;
        };
        
        // Helper function to render SVGs for groups
        window.getGroupIcon = (iconName) => {
            // Simple SVG paths for common icons
            switch (iconName) {
                case 'leaf':
                    return `<svg class="w-6 h-6 mr-3 text-[#10b981]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2zM12 18v3"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 13L9 9M12 13L15 9"></path></svg>`;
                case 'shield':
                    return `<svg class="w-6 h-6 mr-3 text-[#3b82f6]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.617 7.087a1.86 1.86 0 00-.712-.486 9.003 9.003 0 01-15.82 0 1.86 1.86 0 00-.712.486m17.064 0a1.86 1.86 0 01-1.077.785 9.003 9.003 0 01-15.82 0 1.86 1.86 0 01-1.077-.785M12 12V3m0 0l-2 2m2-2l2 2"></path></svg>`;
                case 'bolt':
                    return `<svg class="w-6 h-6 mr-3 text-[#f97316]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`;
                default:
                    return `<span class="w-6 h-6 mr-3 text-gray-400">#</span>`;
            }
        };

        // Custom SVG icons to replace emojis in the home page and dashboard
        window.getIcon = (name, classes) => {
            switch (name) {
                case 'graph-up': // Quantifiable Reduction
                    return `<svg class="${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10l5-5m0 0l5 5m-5-5v14m5 5l5-5m0 0l5 5m-5-5v14"></path></svg>`;
                case 'light-bulb': // AI Personalization
                    return `<svg class="${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.879 16.121A3 3 0 1012 15.5m-2.121.621l-3 3M17 12a5 5 0 11-10 0 5 5 0 0110 0z"></path></svg>`;
                case 'handshake': // Community & Loyalty
                    return `<svg class="${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11.854 16.854a.5.5 0 01-.708 0l-4-4a.5.5 0 01.708-.708L12 15.586l3.854-3.854a.5.5 0 01.708.708l-4 4zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                case 'trophy': // Leaderboard
                    return `<svg class="${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14 10l-2 1m0 0l-2-1m2 1v3.5l1.5 1.5M16 8l1-4h3M8 8l-1-4H3M12 16h2a2 2 0 002-2v-4a2 2 0 00-2-2h-4a2 2 0 00-2 2v4a2 2 0 002 2z"></path></svg>`;
                case 'co2-red':
                    return `<svg class="${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                case 'points':
                    return `<svg class="${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                case 'reduction':
                    return `<svg class="${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8m-4-2H3m0 0v-8m0 8l8-8"></path></svg>`;
                case 'group':
                    return `<svg class="${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20h-2m2 0h-2m0 0H9m1.458-4.5a3 3 0 011.625-2.824M7.785 17.5l-1.637 1.637C5.811 19.467 5 20 4 20h-.5M15 4a3 3 0 11-6 0 3 3 0 016 0zm-6 0h6"></path></svg>`;
                default:
                    return `<span class="${classes}">?</span>`;
            }
        };


        // --- UI Rendering Functions ---

        window.render = () => {
            const app = document.getElementById('app');
            if (!app) return;

            let html = '';
            switch (window.state.view) {
                case 'home':
                    html = window.renderHome();
                    break;
                case 'calculator':
                    html = window.renderCalculator();
                    break;
                case 'dashboard':
                    html = window.renderDashboard();
                    break;
                case 'fullLeaderboard':
                    html = window.renderFullLeaderboard();
                    break;
                case 'achievements':
                    html = window.renderAchievements(); // New View
                    break;
            }
            app.innerHTML = html;

            // Re-attach event listeners after DOM update
            if (window.state.view === 'calculator') {
                document.getElementById('calculator-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    window.handleCalculatorSubmit();
                });
            } else if (window.state.view === 'dashboard') {
                document.getElementById('bot-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const input = e.target.querySelector('input[type="text"]').value;
                    if (input.trim()) {
                        window.getBotResponse(input.trim());
                        e.target.querySelector('input[type="text"]').value = ''; // Clear input
                    }
                });
            }
            
             // Universal event listeners
            document.querySelectorAll('[data-view]').forEach(el => {
                el.onclick = () => window.changeView(el.getAttribute('data-view'));
            });
            document.getElementById('pop-up-trigger')?.addEventListener('click', () => window.showImmediateImprovement());
        };

        window.changeView = (newView) => {
            window.state.view = newView;
            window.render();
            window.scrollTo(0, 0); // Scroll to top on view change
        };
        
        window.showImmediateImprovement = () => {
            // Using a simple message box to replace alert()
            const msg = document.getElementById('message-box');
            msg.querySelector('#message-content').innerHTML = `
                <p class="text-2xl font-bold text-[#059669] mb-3">
                    <span class="inline-block align-middle mr-2">
                        <svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM7 9a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                    </span>
                    Instant Climate Win!
                </p>
                <p class="text-gray-700">Did you know choosing to cycle instead of driving for a 5-mile trip saves approximately <strong>1.8 kg of $\text{CO}_2$</strong>?</p>
                <p class="mt-4 text-lg font-semibold">Tap 'Complete' to earn <strong>+50 Quest Points!</strong></p>
            `;
            msg.classList.remove('hidden');
            document.getElementById('message-close').onclick = () => {
                msg.classList.add('hidden');
            };
            document.getElementById('message-action').innerHTML = `
                <button onclick="window.completeInstantQuest()" class="px-6 py-2 btn-primary text-white rounded-lg">Complete Quest</button>
            `;
        };

        window.completeInstantQuest = () => {
            const currentPoints = window.state.userProfile.totalPoints;
            const newPoints = currentPoints + 50;
            const msg = document.getElementById('message-box');
            msg.classList.add('hidden');
            
            // Save updated points
            window.saveUserProfile({ totalPoints: newPoints });

            // Show confirmation
            const conf = document.getElementById('message-box');
            conf.querySelector('#message-content').innerHTML = `
                <p class="text-2xl font-bold text-[#059669] mb-3">SUCCESS!</p>
                <p class="text-gray-700">You earned <strong>50 Quest Points!</strong> Check the leaderboard!</p>
            `;
            conf.classList.remove('hidden');
            document.getElementById('message-action').innerHTML = `
                <button onclick="document.getElementById('message-box').classList.add('hidden');" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition font-semibold">Close</button>
            `;
        };
        
        window.handleCalculatorSubmit = async () => {
            const form = document.getElementById('calculator-form');
            if (!form) return;
            
            const commuteMiles = parseFloat(form.commuteMiles.value) || 0;
            const kwhMonthly = parseFloat(form.kwhMonthly.value) || 0;
            const flightsPerYear = parseFloat(form.flightsPerYear.value) || 0;
            const diet = form.diet.value;

            // Save new profile data
            await window.saveUserProfile({
                commuteMiles,
                kwhMonthly,
                flightsPerYear,
                diet,
                // New users start with a base 500 points
                totalPoints: window.state.userProfile.totalPoints || 500, 
                co2ReducedKg: window.state.userProfile.co2ReducedKg || 0,
            });

            // Transition to dashboard
            window.changeView('dashboard');
        };

        window.handleQuestCompletion = (questId, points) => {
            const questIndex = window.state.dailyQuests.findIndex(q => q.id === questId);
            if (questIndex !== -1 && !window.state.dailyQuests[questIndex].complete) {
                // Mark quest as complete
                window.state.dailyQuests[questIndex].complete = true;

                // Update points
                const newPoints = window.state.userProfile.totalPoints + points;
                
                // Mock a CO2 reduction for completing a quest (e.g., 5 kg)
                const newCo2Reduced = window.state.userProfile.co2ReducedKg + 5; 

                // Save updated state (quests implicitly saved via local state copy in profile)
                window.saveUserProfile({ 
                    totalPoints: newPoints,
                    co2ReducedKg: newCo2Reduced,
                    dailyQuests: window.state.dailyQuests // Save the quest state
                });

                // Show completion message
                const conf = document.getElementById('message-box');
                conf.querySelector('#message-content').innerHTML = `
                    <p class="text-2xl font-bold text-[#059669] mb-3">SUCCESS!</p>
                    <p class="text-gray-700">Quest complete: You earned <strong>${points} Quest Points!</strong></p>
                `;
                conf.classList.remove('hidden');
                document.getElementById('message-action').innerHTML = `
                    <button onclick="document.getElementById('message-box').classList.add('hidden');" class="px-6 py-2 btn-primary text-white rounded-lg">Awesome!</button>
                `;
            }
        };

        window.handleVerification = () => {
            const msg = document.getElementById('message-box');
            msg.querySelector('#message-content').innerHTML = `
                <p class="text-2xl font-bold text-[#059669] mb-3">
                    <span class="inline-block align-middle mr-2">
                        <svg class="w-6 h-6 text-[#10b981]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </span>
                    Verification Submitted
                </p>
                <p class="text-gray-700">Thank you for submitting your daily climate actions! Your points and reductions will be finalized soon.</p>
                <p class="mt-4 text-sm text-gray-500">In a production environment, this triggers blockchain verification (mock demo).</p>
            `;
            msg.classList.remove('hidden');
            document.getElementById('message-action').innerHTML = `
                <button onclick="document.getElementById('message-box').classList.add('hidden');" class="px-6 py-2 btn-primary text-white rounded-lg">Close</button>
            `;
        };

        // Helper function for Streak Calendar
        function getDayLetter(index) {
            const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            const todayIndex = new Date().getDay(); // 0 (Sunday) to 6 (Saturday)
            // Calculate the day of the week for the past 7 days (index 0 is 7 days ago, index 6 is today)
            const targetDayIndex = (todayIndex - (6 - index) + 7) % 7; 
            return dayNames[targetDayIndex];
        }


        // --- HTML TEMPLATES ---

        window.renderHeader = () => `
            <header class="bg-white header-shadow p-4 sticky top-0 z-40">
                <div class="max-w-7xl mx-auto flex justify-between items-center">
                    <div class="text-2xl font-bold text-gray-900 flex items-center">
                        <svg class="w-7 h-7 mr-2 text-[#10b981]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        <span class="font-extrabold text-[#10b981]">Carbon</span><span class="font-light">Quest</span>
                    </div>
                    <nav class="space-x-4 text-sm hidden sm:flex items-center">
                        <button class="text-gray-600 hover:text-[#059669] transition font-medium" data-view="home">Home</button>
                        ${window.state.userProfile.totalCo2Kg > 0 ? `<button class="text-gray-600 hover:text-[#059669] transition font-medium" data-view="dashboard">Dashboard</button>` : ''}
                        
                        <!-- NEW ACHIEVEMENTS BUTTON -->
                        <button class="px-3 py-1 text-sm font-bold bg-yellow-400 text-gray-800 rounded-full hover:bg-yellow-500 transition shadow-md" data-view="achievements">
                            üèÜ Achievements
                        </button>
                        
                        <div class="px-4 py-1 bg-gray-100 text-gray-700 rounded-full font-medium shadow-inner">
                            User ID: ${window.state.userId ? window.state.userId : 'Guest'}
                        </div>
                    </nav>
                    <button class="sm:hidden text-gray-600 hover:text-[#059669]">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
            </header>
        `;

        window.renderHome = () => `
            ${window.renderHeader()}
            <main class="max-w-7xl mx-auto py-20 px-4 sm:px-6 lg:px-8">
                <div class="text-center">
                    <p class="text-base font-semibold text-[#059669] tracking-wider uppercase mb-4">PITCH DEMO: ESG & Behavioral Science</p>
                    
                    <!-- App Logo Visual (Large) -->
                    <div class="mb-10 inline-flex flex-col items-center">
                        <!-- Large SVG: Leaf on a Globe (The actual Logo Icon) -->
                        <svg class="w-24 h-24 text-[#059669]" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <!-- Globe base -->
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21c4.97 0 9-3.582 9-8s-4.03-8-9-8-9 3.582-9 8 4.03 8 9 8z"></path>
                            <!-- Lines of latitude/longitude -->
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v18M3.05 13H21.05M3.05 17H21.05M3.05 9H21.05"></path>
                            <!-- Leaf of Growth -->
                            <path fill="#10b981" stroke="#10b981" stroke-linecap="round" stroke-linejoin="round" d="M12 13c1.333 0 2-1 2-2s-.667-2-2-2-2 1-2 2 .667 2 2 2z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 13v-2m-2-1l-2-2m4 0l2-2M12 13l2 2m-4 0l-2 2"></path>
                        </svg>
                        <div class="mt-3 text-5xl font-extrabold text-gray-900 tracking-tight leading-snug">
                            <span class="font-extrabold text-[#10b981]">Carbon</span><span class="font-light">Quest</span>
                        </div>
                    </div>
                    <!-- End App Logo Visual (Large) -->

                    <h1 class="text-5xl sm:text-7xl font-extrabold text-gray-900 tracking-tight leading-snug">
                        The Climate Crisis Needs a Game Changer.
                    </h1>
                    <p class="mt-8 max-w-3xl mx-auto text-xl text-gray-600">
                        Carbon Quest is an innovative platform that leverages **gamification, AI-driven coaching, and real-time data** (powered by Firestore) to transform individual climate intent into measurable, collective action.
                    </p>
                    
                    <div class="mt-12 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6">
                        <button class="btn-primary text-xl py-3 px-8 rounded-lg transform transition"
                            data-view="calculator">
                            üöÄ Calculate Footprint & Start Quest
                        </button>
                        <button id="pop-up-trigger" class="py-3 px-8 text-lg font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition shadow-sm">
                            Show Feature: Immediate Impact
                        </button>
                    </div>
                </div>

                <!-- Value Proposition Grid - ADDED GREEN ACCENTS -->
                <div class="mt-24 grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Card 1: Quantifiable Reduction -->
                    <div class="card p-8 text-center border-b-4 border-[#059669] hover:bg-green-50 transition duration-300">
                        <div class="mb-4 flex justify-center">
                            <!-- Icon color changed to deeper green for accent -->
                            ${window.getIcon('graph-up', 'w-10 h-10 text-[#059669]')}
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Quantifiable Reduction</h3>
                        <p class="mt-2 text-gray-500">From complex data to simple, verifiable metrics tracked in real-time with Firestore.</p>
                    </div>
                    <!-- Card 2: AI Personalization -->
                    <div class="card p-8 text-center border-b-4 border-[#059669] hover:bg-green-50 transition duration-300">
                        <div class="mb-4 flex justify-center">
                             <!-- Icon color changed to deeper green for accent -->
                             ${window.getIcon('light-bulb', 'w-10 h-10 text-[#059669]')}
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">AI Personalization</h3>
                        <p class="mt-2 text-gray-500">CarbonBot provides targeted, high-return suggestions to maximize impact per effort.</p>
                    </div>
                    <!-- Card 3: Community & Loyalty -->
                    <div class="card p-8 text-center border-b-4 border-[#059669] hover:bg-green-50 transition duration-300">
                        <div class="mb-4 flex justify-center">
                             <!-- Icon color changed to deeper green for accent -->
                             ${window.getIcon('handshake', 'w-10 h-10 text-[#059669]')}
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Community & Loyalty</h3>
                        <p class="mt-2 text-gray-500">The Leaderboard and Quest system drive competitive loyalty and sustained engagement.</p>
                    </div>
                </div>
            </main>
        `;

        window.renderCalculator = () => {
            const p = window.state.userProfile;
            return `
                ${window.renderHeader()}
                <main class="max-w-3xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                    <div class="card p-8 sm:p-10">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Baseline Footprint Calculation</h2>
                        <p class="text-gray-500 mb-8">This data establishes your starting point and unlocks your personalized reduction strategy.</p>

                        <form id="calculator-form" class="space-y-8">
                            
                            <!-- Section: Transportation -->
                            <fieldset class="border-t border-gray-200 pt-6">
                                <legend class="text-xl font-semibold text-[#10b981] mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 3m0 0l-3 3m3-3h18"></path></svg>
                                    1. Mobility
                                </legend>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="commuteMiles" class="block text-sm font-medium text-gray-700">Weekly Commute Distance (miles, car)</label>
                                        <input type="number" id="commuteMiles" name="commuteMiles" value="${p.commuteMiles}" required class="mt-1 block w-full input-style">
                                    </div>
                                    <div>
                                        <label for="flightsPerYear" class="block text-sm font-medium text-gray-700">Annual Air Travel (long-haul flights)</label>
                                        <input type="number" id="flightsPerYear" name="flightsPerYear" value="${p.flightsPerYear}" required class="mt-1 block w-full input-style">
                                    </div>
                                </div>
                            </fieldset>
                            
                            <!-- Section: Home Energy -->
                            <fieldset class="border-t border-gray-200 pt-6">
                                <legend class="text-xl font-semibold text-[#10b981] mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    2. Home Energy Consumption
                                </legend>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="kwhMonthly" class="block text-sm font-medium text-gray-700">Average Monthly Electricity Usage (kWh)</label>
                                        <input type="number" id="kwhMonthly" name="kwhMonthly" value="${p.kwhMonthly}" required class="mt-1 block w-full input-style">
                                    </div>
                                    <div>
                                        <label for="homeType" class="block text-sm font-medium text-gray-700">Home Energy Source (Mock)</label>
                                        <select id="homeType" name="homeType" class="mt-1 block w-full input-style">
                                            <option value="grid">Standard Grid Mix</option>
                                            <option value="renewables">100% Renewables Plan</option>
                                            <option value="mixed">Mixed/Partial Green</option>
                                        </select>
                                    </div>
                                </div>
                            </fieldset>

                            <!-- Section: Diet -->
                            <fieldset class="border-t border-gray-200 pt-6">
                                <legend class="text-xl font-semibold text-[#10b981] mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882L3 13.5m-3-3l7-7m11 0l7 7"></path></svg>
                                    3. Diet & Lifestyle
                                </legend>
                                <div>
                                    <label for="diet" class="block text-sm font-medium text-gray-700">Primary Diet Type (Most impactful)</label>
                                    <select id="diet" name="diet" value="${p.diet}" required class="mt-1 block w-full input-style">
                                        <option value="omnivore" ${p.diet === 'omnivore' ? 'selected' : ''}>Omnivore (Standard Meat)</option>
                                        <option value="vegetarian" ${p.diet === 'vegetarian' ? 'selected' : ''}>Vegetarian</option>
                                        <option value="vegan" ${p.diet === 'vegan' ? 'selected' : ''}>Vegan (Lowest Footprint)</option>
                                    </select>
                                </div>
                            </fieldset>
                            
                            <div class="pt-6">
                                <button type="submit" class="w-full btn-primary text-xl py-3 px-6 rounded-lg shadow-xl">
                                    Analyze & Unlock Dashboard
                                </button>
                            </div>
                        </form>
                    </div>
                </main>
            `;
        };

        window.renderDashboard = () => {
            const p = window.state.userProfile;
            const co2Score = p.totalCo2Kg.toLocaleString();
            const avgCo2 = 16000; // Mock national average
            const rank = window.state.leaderboard.find(i => i.id === window.state.userId)?.rank || '-';
            const boardData = window.state.leaderboard.slice(0, 5); // Top 5 for display
            const currentGroup = window.state.groups.find(g => g.id === p.groupId);
            
            // Mock data for the visualization placeholder
            const breakdown = [
                { source: 'Transportation', value: p.commuteMiles * 52 * 0.4, color: 'bg-red-500', name: 'Travel' },
                { source: 'Home Energy', value: p.kwhMonthly * 12 * ELECTRICITY_KG_PER_KWH, color: 'bg-blue-500', name: 'Home' },
                { source: 'Diet', value: 2500 * DIET_FACTORS[p.diet], color: 'bg-green-600', name: 'Food' },
                { source: 'Flights', value: p.flightsPerYear * 1000, color: 'bg-yellow-500', name: 'Air' }
            ].sort((a, b) => b.value - a.value); // Sort descending for better visualization

            const totalBreakdown = breakdown.reduce((sum, item) => sum + item.value, 0);
            const highestImpact = breakdown[0].source;


            return `
                ${window.renderHeader()}
                <main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                    <h2 class="text-4xl font-extrabold text-gray-900 mb-10">Your Climate Quest Dashboard</h2>
                    
                    <!-- Top Stats Grid (Enhanced Styling) -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                        <div class="stat-box stat-box-red">
                            <div class="flex items-center text-gray-500">
                                ${window.getIcon('co2-red', 'w-6 h-6 mr-2 text-red-500')}
                                <p class="text-sm font-medium">Annual $\text{CO}_2$ Baseline</p>
                            </div>
                            <p class="text-4xl font-extrabold text-gray-900 mt-2">${co2Score} <span class="text-base font-semibold text-gray-500">kg $\text{CO}_2$e</span></p>
                            <p class="text-xs text-gray-400 mt-2">Target: Below ${avgCo2.toLocaleString()} kg (National Avg)</p>
                        </div>
                        <div class="stat-box stat-box-blue">
                            <div class="flex items-center text-gray-500">
                                ${window.getIcon('points', 'w-6 h-6 mr-2 text-blue-500')}
                                <p class="text-sm font-medium">Total Quest Points</p>
                            </div>
                            <p class="text-4xl font-extrabold text-gray-900 mt-2">${p.totalPoints.toLocaleString()} <span class="text-base font-semibold text-gray-500">Pts</span></p>
                            <p class="text-xs text-gray-400 mt-2">Global Rank: <strong class="text-blue-500">#${rank}</strong></p>
                        </div>
                        <div class="stat-box stat-box-green">
                            <div class="flex items-center text-gray-500">
                                ${window.getIcon('reduction', 'w-6 h-6 mr-2 text-green-500')}
                                <p class="text-sm font-medium">Total Reduction Achieved</p>
                            </div>
                            <p class="text-4xl font-extrabold text-gray-900 mt-2">${p.co2ReducedKg.toLocaleString()} <span class="text-base font-semibold text-gray-500">kg $\text{CO}_2$e</span></p>
                            <p class="text-xs text-gray-400 mt-2">Equivalent to ${Math.round(p.co2ReducedKg / 100)} trees planted</p>
                        </div>
                        <div class="stat-box stat-box-orange">
                            <div class="flex items-center text-gray-500">
                                ${window.getIcon('group', 'w-6 h-6 mr-2 text-orange-500')}
                                <p class="text-sm font-medium">Community Group</p>
                            </div>
                            <p class="text-2xl font-extrabold text-gray-900 mt-2 truncate">
                                ${currentGroup ? currentGroup.name : 'Not Joined'}
                            </p>
                            <p class="text-xs text-gray-400 mt-2">
                                ${currentGroup ? `Group Score: ${currentGroup.score.toLocaleString()} Pts` : '<button onclick="window.changeView(\'fullLeaderboard\')" class="text-orange-500 hover:underline font-semibold">Join a Group</button>'}
                            </p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        <!-- 1. Quests Column (2/3 width) -->
                        <div class="lg:col-span-2 space-y-8">
                            
                            <!-- Footprint Visualization (New Stacked Bar) -->
                            <div class="card p-8">
                                <h3 class="text-2xl font-bold text-gray-900 mb-2">Footprint Composition</h3>
                                <p class="text-gray-500 mb-6">Your largest area for high-impact action is: <strong class="text-red-500">${highestImpact}</strong></p>
                                
                                <div class="stacked-bar-container flex bg-gray-200">
                                    ${breakdown.map(item => {
                                        const percentage = (item.value / totalBreakdown) * 100;
                                        // Ensure the largest segment has enough space for text
                                        const text = percentage > 10 ? `${item.name}` : '';
                                        const textColor = percentage > 25 ? 'text-white' : 'text-gray-900';
                                        
                                        return `
                                            <div style="width: ${percentage.toFixed(1)}%;" 
                                                 class="stacked-bar-segment ${item.color} ${textColor} text-xs font-bold"
                                                 title="${item.source}: ${item.value.toLocaleString()} kg $\text{CO}_2$e">
                                                ${text}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>

                                <div class="mt-4 flex flex-wrap justify-between text-sm">
                                    ${breakdown.map(item => `
                                        <div class="flex items-center mt-2 mr-4">
                                            <span class="inline-block w-3 h-3 rounded-full ${item.color} mr-2"></span>
                                            <span class="text-gray-700">${item.source}: <strong class="font-semibold">${Math.round(item.value).toLocaleString()} kg</strong></span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Daily Quests Card -->
                            <div class="card p-8">
                                <h3 class="text-2xl font-bold text-gray-900 mb-6 flex justify-between items-center">
                                    Daily Quests 
                                    <span class="text-base font-semibold text-[#10b981]">
                                        ${window.state.dailyQuests.filter(q => q.complete).length} / ${window.state.dailyQuests.length} Completed
                                    </span>
                                </h3>
                                <div class="space-y-4">
                                    ${window.state.dailyQuests.map(quest => `
                                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border-l-4 ${quest.complete ? 'border-green-400' : 'border-yellow-400'} shadow-sm">
                                            <div class="flex items-center">
                                                ${quest.complete ? 
                                                    `<svg class="w-6 h-6 mr-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` : 
                                                    `<svg class="w-6 h-6 mr-3 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M18.83 4.22a9 9 0 11-13.66 0M21 12a9 9 0 01-18 0"></path></svg>`}
                                                <p class="text-base ${quest.complete ? 'text-gray-500 line-through' : 'text-gray-700'} font-medium">${quest.text}</p>
                                            </div>
                                            <button 
                                                onclick="window.handleQuestCompletion(${quest.id}, ${quest.points})"
                                                class="text-sm font-semibold py-1 px-4 rounded-full transition ${quest.complete ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'btn-primary'}"
                                                ${quest.complete ? 'disabled' : ''}>
                                                ${quest.complete ? 'Done' : `+${quest.points} Pts`}
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Verification Button (below quests) -->
                            <button onclick="window.handleVerification()" class="w-full btn-primary text-lg py-3 px-8 rounded-lg transform transition shadow-lg flex items-center justify-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Submit & Verify Daily Actions
                            </button>
                            
                        </div>

                        <!-- 2. AI Bot & Leaderboard Column (1/3 width) -->
                        <div class="lg:col-span-1 space-y-8">
                            
                            <!-- CarbonBot AI Agent Card -->
                            <div class="card p-6">
                                <h3 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                                    <span class="inline-block mr-2 w-7 h-7">
                                        <!-- Robot/Bot Icon -->
                                        <svg class="text-[#3b82f6]" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3 14H9v-2h6v2zm1-5c-.34 0-.67-.04-1-.1l-1.39-2.78c-.28-.56-.91-.84-1.5-.72l-.76.15c-.59.12-1.22-.16-1.5-.72L8 8.1c-.33-.06-.66-.1-.99-.1-1.38 0-2.5 1.12-2.5 2.5 0 .85.43 1.58 1.07 2.01L7 13.5l1.39 2.78c.28.56.91.84 1.5.72l.76-.15c.59.12 1.22.16 1.5.72l1.39 2.78c.33.06.66.1.99.1 1.38 0 2.5-1.12 2.5-2.5 0-.85-.43-1.58-1.07-2.01zM10.5 8.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm3 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg>
                                    </span>
                                    CarbonBot AI Coach
                                </h3>
                                <div class="bg-gray-50 p-4 rounded-lg mb-4 h-40 overflow-y-auto text-sm border border-gray-200 shadow-inner">
                                    <p class="text-gray-700 leading-relaxed">${window.state.botResponse}</p>
                                </div>
                                <form id="bot-form">
                                    <input type="text" placeholder="e.g., How can I reduce my transportation $\text{CO}_2$?"
                                        class="w-full input-style p-2 mb-3" required>
                                    <button type="submit" class="w-full btn-primary py-2 rounded-lg text-sm font-semibold">
                                        Get AI Recommendation
                                    </button>
                                </form>
                            </div>
                            
                            <!-- Leaderboard Card -->
                            <div class="card p-6 cursor-pointer hover:shadow-lg transition duration-200" onclick="window.changeView('fullLeaderboard')">
                                <h3 class="text-2xl font-bold text-gray-900 mb-4 flex justify-between items-center">
                                    ${window.getIcon('trophy', 'w-6 h-6 mr-2 text-[#f97316]')}
                                    Global Leaderboard
                                    <span class="text-sm font-medium text-[#3b82f6] hover:underline">View All &rarr;</span>
                                </h3>
                                <div class="space-y-2">
                                    <!-- Header Row -->
                                    <div class="flex justify-between items-center p-2 text-sm font-semibold text-gray-500 border-b border-gray-200">
                                        <span class="w-1/4">Rank</span>
                                        <span class="w-1/2">User</span>
                                        <span class="w-1/4 text-right">Points</span>
                                    </div>
                                    <!-- Data Rows (Top 5) -->
                                    ${boardData.slice(0, 5).map((item, index) => `
                                        <div class="flex justify-between items-center p-2 rounded-lg transition ${item.id === window.state.userId ? 'bg-[#e0f2f1] font-bold border border-[#10b981]' : 'hover:bg-gray-50'}">
                                            <span class="w-1/4 text-lg font-extrabold text-[#10b981]">${item.rank}</span>
                                            <span class="w-1/2 text-gray-700 truncate" title="${item.name}">${item.name}</span>
                                            <span class="w-1/4 text-right text-sm font-medium text-gray-600">${item.totalPoints.toLocaleString()}</span>
                                        </div>
                                    `).join('')}
                                    ${boardData.length === 0 ? `<p class="text-center text-gray-500 py-2 text-sm">No data yet. Complete your first quest!</p>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            `;
        };

        window.renderFullLeaderboard = () => {
            const board = window.state.leaderboard;
            const userRank = board.find(i => i.id === window.state.userId)?.rank || '-';
            const p = window.state.userProfile;
            const currentGroup = window.state.groups.find(g => g.id === p.groupId);

            return `
                ${window.renderHeader()}
                <main class="max-w-5xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                    <button onclick="window.changeView('dashboard')" class="text-gray-600 hover:text-[#059669] mb-6 flex items-center transition font-medium">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Back to Dashboard
                    </button>
                    <div class="card p-8 mb-8">
                        <h2 class="text-4xl font-extrabold text-gray-900 mb-2 flex items-center">
                            <span class="text-4xl mr-3">
                                ${window.getIcon('trophy', 'w-10 h-10 text-[#f97316]')}
                            </span>
                            Full Global Leaderboard
                        </h2>
                        <p class="text-gray-500 mb-8">Compete with other users! Your current rank is <strong class="text-[#3b82f6]">#${userRank}</strong>.</p>
                        
                        <div class="space-y-2">
                            <!-- Header Row -->
                            <div class="flex justify-between items-center p-3 text-sm font-extrabold text-white bg-gray-700 rounded-t-lg">
                                <span class="w-1/6 text-left">RANK</span>
                                <span class="w-2/5 text-left">USER ID / NAME</span>
                                <span class="w-1/4 text-center">REDUCTION (kg $\text{CO}_2$)</span>
                                <span class="w-1/6 text-right">POINTS</span>
                            </div>
                            <!-- Data Rows -->
                            ${board.map((item, index) => `
                                <div class="flex justify-between items-center p-3 rounded-lg transition text-sm ${item.id === window.state.userId ? 'bg-[#e0f2f1] font-bold border border-[#10b981]' : 'hover:bg-gray-50 bg-white border border-gray-100'}">
                                    <span class="w-1/6 text-left text-lg font-bold ${index === 0 ? 'text-[#FFD700]' : index === 1 ? 'text-[#C0C0C0]' : index === 2 ? 'text-[#CD7F32]' : 'text-gray-600'}">
                                        #${item.rank}
                                    </span>
                                    <span class="w-2/5 text-gray-700 font-medium truncate" title="${item.id}">
                                        ${item.name} ${item.id === window.state.userId ? '(You)' : ''}
                                    </span>
                                    <span class="w-1/4 text-center text-red-500 font-semibold">${item.co2ReducedKg.toLocaleString()}</span>
                                    <span class="w-1/6 text-right text-[#059669] font-extrabold">${item.totalPoints.toLocaleString()}</span>
                                
                                </div>
                            `).join('')}
                            
                            ${board.length === 0 ? `<p class="text-center text-gray-500 py-6">Loading leaderboard data...</p>` : ''}
                        </div>
                    </div>

                    <!-- Available Groups Card (NOW ON FULL LEADERBOARD) -->
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="inline-block mr-2 w-7 h-7">
                                <!-- Handshake/Group Icon -->
                                <svg class="text-[#f97316]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 10h-2m-3-1l-3 3 3 3m2-4v5.5a2.5 2.5 0 01-5 0v-5.5M12 21a9 9 0 110-18 9 9 0 010 18z"></path></svg>
                            </span>
                            Available Groups ${currentGroup ? `(You are in: <span class="text-[#f97316] ml-2">${currentGroup.name}</span>)` : ''}
                        </h3>
                        <p class="text-gray-500 mb-6">Join a group to contribute to a collective score and access exclusive group quests!</p>
                        <div class="space-y-4">
                            ${window.state.groups.map(group => `
                                <div class="p-3 border-b border-gray-100 last:border-b-0 ${group.id === p.groupId ? 'bg-indigo-50 rounded-lg border-2 border-indigo-200' : 'hover:bg-gray-50 rounded-lg'}">
                                    <div class="flex justify-between items-start">
                                        <div class="flex items-center">
                                            ${window.getGroupIcon(group.icon)}
                                            <div>
                                                <p class="font-semibold text-gray-800">${group.name}</p>
                                                <p class="text-xs text-gray-500 mt-1">${group.motto}</p>
                                                <p class="text-sm text-[#059669] font-medium mt-2">Group Score: ${group.score.toLocaleString()} | Members: ${group.members}</p>
                                            </div>
                                        </div>
                                        ${group.id === p.groupId 
                                            ? `<button onclick="window.handleGroupAction('${group.id}', 'leave')" class="text-sm font-semibold py-1 px-3 rounded-full bg-red-500 text-white hover:bg-red-600 transition shadow-md">Leave Group</button>`
                                            : `<button onclick="window.handleGroupAction('${group.id}', 'join')" class="text-sm font-semibold py-1 px-3 rounded-full bg-[#3b82f6] text-white hover:bg-[#2563eb] transition shadow-md">Join Group</button>`
                                        }
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </main>
            `;
        };

        // --- NEW ACHIEVEMENTS PAGE RENDERER ---
        window.renderAchievements = () => {
            const { streaks, badges } = MOCK_ACHIEVEMENT_DATA;
            const earnedCount = badges.filter(b => b.earned).length;

            // Helper to render streak calendar days
            const renderCalendar = () => {
                return MOCK_ACHIEVEMENT_DATA.streaks.last7Days.map((completed, index) => {
                    const dayLetter = getDayLetter(index);
                    const isToday = index === 6;

                    let dayClass = completed ? 'streak-complete' : 'streak-missed';
                    if (isToday) {
                        dayClass += ' streak-today border-2 border-dashed border-gray-900';
                    }

                    // Display index 1 (Today) down to 7 (7 days ago) 
                    const displayDay = 7 - index; 

                    return `
                        <div class="flex flex-col items-center">
                            <span class="text-sm text-gray-500 mb-2">${dayLetter}</span>
                            <div class="achieve-day ${dayClass}">${displayDay}</div>
                        </div>
                    `;
                }).join('');
            };

            // Helper to render badges
            const renderBadgesGrid = () => {
                return badges.map(badge => {
                    const isEarned = badge.earned;
                    const containerClasses = isEarned
                        ? 'p-4 bg-gray-50 rounded-lg text-center border-2 border-yellow-400 shadow-lg'
                        : 'p-4 bg-gray-200 rounded-lg text-center border-2 border-gray-300 opacity-60';

                    const detailText = isEarned
                        ? `<p class="text-xs text-[#059669] mt-1 font-semibold">Achieved: ${badge.date}</p>`
                        : `<p class="text-xs text-gray-500 mt-1">${badge.goal}</p>`;

                    const emoji = isEarned ? badge.emoji : 'üîí';
                    const nameColor = isEarned ? 'text-gray-900' : 'text-gray-500';

                    return `
                        <div class="${containerClasses} transition duration-200 hover:scale-[1.02]">
                            <span class="text-5xl block mb-2">${emoji}</span>
                            <p class="font-extrabold ${nameColor} text-sm">${badge.name}</p>
                            ${detailText}
                        </div>
                    `;
                }).join('');
            };
            
            return `
                ${window.renderHeader()}
                <main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-10 text-center">
                        <span class="text-yellow-500 mr-3">üèÜ</span> Behavioral & Achievement Analytics
                    </h1>

                    <!-- Streaks Section -->
                    <div class="card p-6 md:p-8 mb-12 border-t-4 border-[#059669]">
                        <h2 class="text-2xl font-bold text-[#059669] mb-6 flex items-center">
                            üî• Daily Compliance Streaks
                        </h2>
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <div>
                                <p class="text-gray-500 text-lg">Current Compliance Period:</p>
                                <p class="text-6xl font-black text-gray-900 mt-1">${streaks.current} <span class="text-2xl font-bold text-gray-600">Days</span></p>
                            </div>
                            <div>
                                <p class="text-gray-500 text-lg">Max Compliance Record:</p>
                                <p class="text-6xl font-black text-yellow-500 mt-1">${streaks.longest} <span class="text-2xl font-bold text-gray-600">Days</span></p>
                            </div>
                        </div>

                        <!-- Streak Calendar -->
                        <div class="flex justify-around bg-gray-50 p-4 rounded-xl border">
                            ${renderCalendar()}
                        </div>
                    </div>

                    <!-- Badges and Achievements Grid Section -->
                    <div class="card p-6 md:p-8 border-t-4 border-yellow-500">
                        <h2 class="text-2xl font-bold text-yellow-500 mb-6 flex justify-between items-center">
                            <span>üèÖ Milestones Achieved (${earnedCount}/${badges.length})</span>
                            <span class="text-base font-semibold text-gray-500">${badges.length - earnedCount} remaining</span>
                        </h2>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6">
                            ${renderBadgesGrid()}
                        </div>
                    </div>
                </main>
            `;
        };


        window.renderFullLeaderboard = () => {
            const board = window.state.leaderboard;
            const userRank = window.state.leaderboard.find(i => i.id === window.state.userId)?.rank || '-';
            const p = window.state.userProfile;
            const currentGroup = window.state.groups.find(g => g.id === p.groupId);

            return `
                ${window.renderHeader()}
                <main class="max-w-5xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                    <button onclick="window.changeView('dashboard')" class="text-gray-600 hover:text-[#059669] mb-6 flex items-center transition font-medium">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Back to Dashboard
                    </button>
                    <div class="card p-8 mb-8">
                        <h2 class="text-4xl font-extrabold text-gray-900 mb-2 flex items-center">
                            <span class="text-4xl mr-3">
                                ${window.getIcon('trophy', 'w-10 h-10 text-[#f97316]')}
                            </span>
                            Full Global Leaderboard
                        </h2>
                        <p class="text-gray-500 mb-8">Compete with other users! Your current rank is <strong class="text-[#3b82f6]">#${userRank}</strong>.</p>
                        
                        <div class="space-y-2">
                            <!-- Header Row -->
                            <div class="flex justify-between items-center p-3 text-sm font-extrabold text-white bg-gray-700 rounded-t-lg">
                                <span class="w-1/6 text-left">RANK</span>
                                <span class="w-2/5 text-left">USER ID / NAME</span>
                                <span class="w-1/4 text-center">REDUCTION (kg $\text{CO}_2$)</span>
                                <span class="w-1/6 text-right">POINTS</span>
                            </div>
                            <!-- Data Rows -->
                            ${board.map((item, index) => `
                                <div class="flex justify-between items-center p-3 rounded-lg transition text-sm ${item.id === window.state.userId ? 'bg-[#e0f2f1] font-bold border border-[#10b981]' : 'hover:bg-gray-50 bg-white border border-gray-100'}">
                                    <span class="w-1/6 text-left text-lg font-bold ${index === 0 ? 'text-[#FFD700]' : index === 1 ? 'text-[#C0C0C0]' : index === 2 ? 'text-[#CD7F32]' : 'text-gray-600'}">
                                        #${item.rank}
                                    </span>
                                    <span class="w-2/5 text-gray-700 font-medium truncate" title="${item.id}">
                                        ${item.name} ${item.id === window.state.userId ? '(You)' : ''}
                                    </span>
                                    <span class="w-1/4 text-center text-red-500 font-semibold">${item.co2ReducedKg.toLocaleString()}</span>
                                    <span class="w-1/6 text-right text-[#059669] font-extrabold">${item.totalPoints.toLocaleString()}</span>
                                
                                </div>
                            `).join('')}
                            
                            ${board.length === 0 ? `<p class="text-center text-gray-500 py-6">Loading leaderboard data...</p>` : ''}
                        </div>
                    </div>

                    <!-- Available Groups Card (NOW ON FULL LEADERBOARD) -->
                    <div class="card p-6">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                            <span class="inline-block mr-2 w-7 h-7">
                                <!-- Handshake/Group Icon -->
                                <svg class="text-[#f97316]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 10h-2m-3-1l-3 3 3 3m2-4v5.5a2.5 2.5 0 01-5 0v-5.5M12 21a9 9 0 110-18 9 9 0 010 18z"></path></svg>
                            </span>
                            Available Groups ${currentGroup ? `(You are in: <span class="text-[#f97316] ml-2">${currentGroup.name}</span>)` : ''}
                        </h3>
                        <p class="text-gray-500 mb-6">Join a group to contribute to a collective score and access exclusive group quests!</p>
                        <div class="space-y-4">
                            ${window.state.groups.map(group => `
                                <div class="p-3 border-b border-gray-100 last:border-b-0 ${group.id === p.groupId ? 'bg-indigo-50 rounded-lg border-2 border-indigo-200' : 'hover:bg-gray-50 rounded-lg'}">
                                    <div class="flex justify-between items-start">
                                        <div class="flex items-center">
                                            ${window.getGroupIcon(group.icon)}
                                            <div>
                                                <p class="font-semibold text-gray-800">${group.name}</p>
                                                <p class="text-xs text-gray-500 mt-1">${group.motto}</p>
                                                <p class="text-sm text-[#059669] font-medium mt-2">Group Score: ${group.score.toLocaleString()} | Members: ${group.members}</p>
                                            </div>
                                        </div>
                                        ${group.id === p.groupId 
                                            ? `<button onclick="window.handleGroupAction('${group.id}', 'leave')" class="text-sm font-semibold py-1 px-3 rounded-full bg-red-500 text-white hover:bg-red-600 transition shadow-md">Leave Group</button>`
                                            : `<button onclick="window.handleGroupAction('${group.id}', 'join')" class="text-sm font-semibold py-1 px-3 rounded-full bg-[#3b82f6] text-white hover:bg-[#2563eb] transition shadow-md">Join Group</button>`
                                        }
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </main>
            `;
        };


        // --- Message Box (Replaces alert/confirm) ---
        window.renderMessageBox = () => `
            <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden flex items-center justify-center z-50 p-4">
                <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all text-center">
                    <div id="message-content" class="mb-6"></div>
                    <div id="message-action" class="flex justify-center space-x-4">
                        <button id="message-close" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold">Dismiss</button>
                    </div>
                </div>
            </div>
        `;

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Append message box to body
            document.body.insertAdjacentHTML('beforeend', window.renderMessageBox());
            
            // Start Firebase Authentication
            window.authInit().then(() => {
                // Initial render once auth is attempted
                window.render();
            });
        });
    </script>
</head>
<body>
    <div id="app" class="min-h-screen">
        <!-- Content will be rendered here by JavaScript -->
        <div class="flex justify-center items-center min-h-screen">
             <div class="text-center p-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#10b981] mx-auto mb-4"></div>
                <p class="text-gray-600">Initializing Carbon Quest for VC Demo...</p>
            </div>
        </div>
    </div>
    
    <!-- Floating CarbonBot Icon (Professional) -->
    <div class="floating-bot card p-3 hover:bg-gray-50 transition" onclick="window.changeView('dashboard');">
        <svg class="w-9 h-9 text-[#10b981]" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-2 0c0 .993-.241 1.942-.689 2.784-.448.842-1.077 1.543-1.854 2.083a6.002 6.002 0 00-.734-.572c-.17-.116-.34-.231-.51-.347-.384-.262-.772-.519-1.164-.768-1.54-.996-3.134-1.503-4.733-1.503s-3.193.507-4.733 1.503c-.392.249-.78.506-1.164.768-.17.116-.34.231-.51.347a6.002 6.002 0 00-.734.572c-.777-.54-1.406-1.241-1.854-2.083C4.241 11.942 4 10.993 4 10a6 6 0 0110.37-4.24l.953.953a.5.5 0 00.707 0l1.06-.06a.5.5 0 000-.707l-.953-.953A7.962 7.962 0 0118 10z" clip-rule="evenodd"></path></svg>
        <div class="text-xs font-semibold text-gray-700 mt-1">CarbonBot</div>
    </div>
</body>
</html>
